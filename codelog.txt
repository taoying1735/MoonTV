# MoonTV é¡¹ç›®æ–‡ä»¶ç»“æ„åˆ†ææŠ¥å‘Š
ç”Ÿæˆæ—¶é—´: 2025å¹´1æœˆ

## é¡¹ç›®æ¦‚è¿°
MoonTV æ˜¯ä¸€ä¸ªåŸºäº Next.js çš„è§†é¢‘æµåª’ä½“åº”ç”¨ï¼Œæ”¯æŒè±†ç“£ç”µå½±æ•°æ®é›†æˆã€ç”¨æˆ·ç®¡ç†ã€æ’­æ”¾è®°å½•ç­‰åŠŸèƒ½ã€‚

## å®Œæ•´æ–‡ä»¶ç»“æ„

### æ ¹ç›®å½•é…ç½®æ–‡ä»¶
- .eslintrc.js - ESLint ä»£ç è§„èŒƒé…ç½®
- .gitignore - Git å¿½ç•¥æ–‡ä»¶é…ç½®
- .npmrc - npm é…ç½®æ–‡ä»¶
- .nvmrc - Node.js ç‰ˆæœ¬é…ç½®
- .prettierignore - Prettier å¿½ç•¥æ–‡ä»¶é…ç½®
- .prettierrc.js - Prettier ä»£ç æ ¼å¼åŒ–é…ç½®
- commitlint.config.js - æäº¤ä¿¡æ¯è§„èŒƒé…ç½®
- config.json - åº”ç”¨é…ç½®æ–‡ä»¶
- Dockerfile - Docker å®¹å™¨é…ç½®
- jest.config.js - Jest æµ‹è¯•æ¡†æ¶é…ç½®
- jest.setup.js - Jest æµ‹è¯•ç¯å¢ƒè®¾ç½®
- LICENSE - å¼€æºè®¸å¯è¯
- next.config.js - Next.js æ¡†æ¶é…ç½®
- package.json - é¡¹ç›®ä¾èµ–å’Œè„šæœ¬é…ç½®
- pnpm-lock.yaml - pnpm åŒ…ç®¡ç†å™¨é”å®šæ–‡ä»¶
- postcss.config.js - PostCSS é…ç½®
- proxy.worker.js - ä»£ç†å·¥ä½œçº¿ç¨‹
- README.md - é¡¹ç›®è¯´æ˜æ–‡æ¡£
- start.js - åº”ç”¨å¯åŠ¨è„šæœ¬
- tailwind.config.ts - Tailwind CSS é…ç½®
- tsconfig.json - TypeScript é…ç½®
- vercel.json - Vercel éƒ¨ç½²é…ç½®
- D1åˆå§‹åŒ–.md - æ•°æ®åº“åˆå§‹åŒ–æ–‡æ¡£
- rizhi.md - æ„å»ºæ—¥å¿—æ–‡ä»¶
- _headers - Cloudflare Pages å¤´éƒ¨é…ç½®
- _redirects - Cloudflare Pages é‡å®šå‘é…ç½®
- CLOUDFLARE_DEPLOYMENT.md - Cloudflare Pages éƒ¨ç½²æŒ‡å—

### GitHub å·¥ä½œæµ (.github/workflows/)
- docker-image.yml - Docker é•œåƒæ„å»ºå·¥ä½œæµ
- sync.yml - åŒæ­¥å·¥ä½œæµ

### Git é’©å­ (.husky/)
- commit-msg - æäº¤ä¿¡æ¯éªŒè¯é’©å­
- post-merge - åˆå¹¶åé’©å­
- pre-commit - æäº¤å‰é’©å­

### VS Code é…ç½® (.vscode/)
- css.code-snippets - CSS ä»£ç ç‰‡æ®µ
- extensions.json - æ¨èæ‰©å±•é…ç½®
- settings.json - ç¼–è¾‘å™¨è®¾ç½®
- typescriptreact.code-snippets - TypeScript React ä»£ç ç‰‡æ®µ

### å…¬å…±èµ„æº (public/)
- favicon.ico - ç½‘ç«™å›¾æ ‡
- logo.png - åº”ç”¨ Logo
- robots.txt - æœç´¢å¼•æ“çˆ¬è™«é…ç½®
- screenshot.png - åº”ç”¨æˆªå›¾
- icons/ - åº”ç”¨å›¾æ ‡é›†åˆ
  - icon-192x192.png
  - icon-256x256.png
  - icon-384x384.png
  - icon-512x512.png

### è„šæœ¬å·¥å…· (scripts/)
- convert-config.js - é…ç½®è½¬æ¢è„šæœ¬
- generate-manifest.js - æ¸…å•ç”Ÿæˆè„šæœ¬

### æºä»£ç  (src/)

#### åº”ç”¨è·¯ç”± (src/app/)
- globals.css - å…¨å±€æ ·å¼
- layout.tsx - æ ¹å¸ƒå±€ç»„ä»¶
- page.tsx - é¦–é¡µç»„ä»¶
- middleware.ts - ä¸­é—´ä»¶

##### é¡µé¢è·¯ç”±
- admin/page.tsx - ç®¡ç†å‘˜é¡µé¢
- douban/page.tsx - è±†ç“£é¡µé¢
- login/page.tsx - ç™»å½•é¡µé¢
- play/page.tsx - æ’­æ”¾é¡µé¢
- search/page.tsx - æœç´¢é¡µé¢

##### API è·¯ç”± (src/app/api/)
###### ç®¡ç†å‘˜ API (admin/)
- config/route.ts - é…ç½®ç®¡ç†
- reset/route.ts - é‡ç½®åŠŸèƒ½
- site/route.ts - ç«™ç‚¹ç®¡ç†
- source/route.ts - èµ„æºç®¡ç†
- user/route.ts - ç”¨æˆ·ç®¡ç†

###### æ ¸å¿ƒ API
- cron/route.ts - å®šæ—¶ä»»åŠ¡
- detail/route.ts - è¯¦æƒ…è·å–
- favorites/route.ts - æ”¶è—ç®¡ç†
- image-proxy/route.ts - å›¾ç‰‡ä»£ç†
- login/route.ts - ç™»å½•è®¤è¯
- logout/route.ts - ç™»å‡º
- playrecords/route.ts - æ’­æ”¾è®°å½•
- register/route.ts - ç”¨æˆ·æ³¨å†Œ
- searchhistory/route.ts - æœç´¢å†å²
- server-config/route.ts - æœåŠ¡å™¨é…ç½®

###### è±†ç“£ API (douban/)
- route.ts - è±†ç“£ä¸»æ¥å£
- categories/route.ts - åˆ†ç±»æ¥å£

###### æœç´¢ API (search/)
- route.ts - æœç´¢ä¸»æ¥å£
- one/route.ts - å•ä¸ªæœç´¢
- resources/route.ts - èµ„æºæœç´¢

#### ç»„ä»¶åº“ (src/components/)
- BackButton.tsx - è¿”å›æŒ‰é’®ç»„ä»¶
- CapsuleSwitch.tsx - èƒ¶å›Šå¼€å…³ç»„ä»¶
- ContinueWatching.tsx - ç»§ç»­è§‚çœ‹ç»„ä»¶
- DoubanCardSkeleton.tsx - è±†ç“£å¡ç‰‡éª¨æ¶å±
- DoubanSelector.tsx - è±†ç“£é€‰æ‹©å™¨
- EpisodeSelector.tsx - å‰§é›†é€‰æ‹©å™¨
- ImagePlaceholder.tsx - å›¾ç‰‡å ä½ç¬¦
- LogoutButton.tsx - ç™»å‡ºæŒ‰é’®
- MobileBottomNav.tsx - ç§»åŠ¨ç«¯åº•éƒ¨å¯¼èˆª
- MobileHeader.tsx - ç§»åŠ¨ç«¯å¤´éƒ¨
- PageLayout.tsx - é¡µé¢å¸ƒå±€ç»„ä»¶
- ScrollableRow.tsx - å¯æ»šåŠ¨è¡Œç»„ä»¶
- SettingsButton.tsx - è®¾ç½®æŒ‰é’®
- Sidebar.tsx - ä¾§è¾¹æ ç»„ä»¶
- SiteProvider.tsx - ç«™ç‚¹æä¾›è€…
- ThemeProvider.tsx - ä¸»é¢˜æä¾›è€…
- ThemeToggle.tsx - ä¸»é¢˜åˆ‡æ¢å™¨
- VideoCard.tsx - è§†é¢‘å¡ç‰‡ç»„ä»¶

#### å·¥å…·åº“ (src/lib/)
- admin.types.ts - ç®¡ç†å‘˜ç±»å‹å®šä¹‰
- auth.ts - è®¤è¯å·¥å…·
- config.ts - é…ç½®å·¥å…·
- d1.db.ts - D1 æ•°æ®åº“å·¥å…·
- db.client.ts - æ•°æ®åº“å®¢æˆ·ç«¯
- db.ts - æ•°æ®åº“å·¥å…·
- douban.client.ts - è±†ç“£å®¢æˆ·ç«¯
- downstream.ts - ä¸‹æ¸¸æœåŠ¡å·¥å…·
- fetchVideoDetail.ts - è§†é¢‘è¯¦æƒ…è·å–
- redis.db.ts - Redis æ•°æ®åº“å·¥å…·
- types.ts - ç±»å‹å®šä¹‰
- upstash.db.ts - Upstash æ•°æ®åº“å·¥å…·
- utils.ts - é€šç”¨å·¥å…·å‡½æ•°

#### æ ·å¼æ–‡ä»¶ (src/styles/)
- colors.css - é¢œè‰²å®šä¹‰
- globals.css - å…¨å±€æ ·å¼

## æŠ€æœ¯æ ˆåˆ†æ
- å‰ç«¯æ¡†æ¶: Next.js (App Router)
- æ ·å¼: Tailwind CSS + CSS Modules
- è¯­è¨€: TypeScript
- æ•°æ®åº“: æ”¯æŒå¤šç§æ•°æ®åº“ (D1, Redis, Upstash)
- éƒ¨ç½²: Vercel + Cloudflare Pages
- åŒ…ç®¡ç†: pnpm
- ä»£ç è§„èŒƒ: ESLint + Prettier
- æµ‹è¯•: Jest
- å®¹å™¨åŒ–: Docker

## ä¸»è¦åŠŸèƒ½æ¨¡å—
1. ç”¨æˆ·è®¤è¯ç³»ç»Ÿ (ç™»å½•/æ³¨å†Œ/ç™»å‡º)
2. è§†é¢‘æ’­æ”¾åŠŸèƒ½
3. è±†ç“£ç”µå½±æ•°æ®é›†æˆ
4. æœç´¢åŠŸèƒ½ (å¤šç§æœç´¢æ–¹å¼)
5. æ”¶è—å’Œæ’­æ”¾è®°å½•
6. ç®¡ç†å‘˜åå°
7. å“åº”å¼è®¾è®¡ (æ”¯æŒç§»åŠ¨ç«¯)
8. ä¸»é¢˜åˆ‡æ¢åŠŸèƒ½
9. å›¾ç‰‡ä»£ç†æœåŠ¡
10. å®šæ—¶ä»»åŠ¡ç³»ç»Ÿ

## æ›´æ”¹è®°å½•

### 2025å¹´1æœˆ - é¡¹ç›®æ–‡ä»¶ç»“æ„åˆ†æ
- å®Œæˆé¡¹ç›®æ–‡ä»¶ç»“æ„åˆ†æï¼Œåˆ›å»ºè¯¦ç»†çš„æ–‡ä»¶æ¸…å•è®°å½•

### 2025å¹´1æœˆ - Cloudflare Pages éƒ¨ç½²ä¼˜åŒ–

#### é—®é¢˜åˆ†æ
æ ¹æ® rizhi.md æ„å»ºæ—¥å¿—ï¼Œå‘ç° Cloudflare Pages éƒ¨ç½²å¤±è´¥çš„ä¸»è¦åŸå› ï¼š
- webpack ç¼“å­˜æ–‡ä»¶ `cache/webpack/client-production/0.pack` å¤§å°ä¸º 38.7 MiB
- è¶…å‡º Cloudflare Pages 25 MiB æ–‡ä»¶å¤§å°é™åˆ¶
- Webpack é…ç½®é”™è¯¯ï¼š`configuration.optimization has an unknown property 'cache'`

#### è§£å†³æ–¹æ¡ˆå®æ–½

1. **ä¼˜åŒ– next.config.js**
   - æ·»åŠ ç¯å¢ƒå˜é‡æ£€æµ‹ï¼Œæ ¹æ® CF_PAGES è‡ªåŠ¨åˆ‡æ¢è¾“å‡ºæ¨¡å¼
   - ä¿®å¤ webpack é…ç½®ï¼šå°† `cache: false` ç§»åˆ°æ­£ç¡®ä½ç½®
   - é…ç½® webpack ä¼˜åŒ–ï¼šé™åˆ¶ chunk å¤§å°ä¸º 20MB
   - å¯ç”¨ CSS ä¼˜åŒ–å’Œ Gzip å‹ç¼©
   - æ·»åŠ è¯¦ç»†çš„ä¸­æ–‡æ³¨é‡Š

2. **ä¼˜åŒ– .gitignore**
   - æ·»åŠ  webpack ç¼“å­˜æ–‡ä»¶å¿½ç•¥è§„åˆ™
   - æ·»åŠ  Cloudflare ç›¸å…³æ–‡ä»¶å¿½ç•¥
   - æ·»åŠ  PWA ç”Ÿæˆæ–‡ä»¶å¿½ç•¥
   - æ·»åŠ  IDE å’Œæ“ä½œç³»ç»Ÿæ–‡ä»¶å¿½ç•¥

3. **ä¼˜åŒ– package.json æ„å»ºè„šæœ¬**
   - æ–°å¢ `build:cf` å‘½ä»¤ï¼šä¸“ç”¨äº Cloudflare Pages æ„å»º
   - ä¿®å¤ `clean` å‘½ä»¤ï¼šWindows å…¼å®¹æ€§ (ä½¿ç”¨ PowerShell)
   - ä¼˜åŒ– `pages:build` å‘½ä»¤ï¼šä½¿ç”¨æ–°çš„æ„å»ºæµç¨‹

4. **åˆ›å»º Cloudflare Pages é…ç½®æ–‡ä»¶**
   - `_headers`ï¼šé…ç½® Gzip å‹ç¼©å’Œç¼“å­˜ç­–ç•¥
   - `_redirects`ï¼šå¤„ç† SPA è·¯ç”±å’Œ API é‡å®šå‘

5. **åˆ›å»ºéƒ¨ç½²æŒ‡å—**
   - `CLOUDFLARE_DEPLOYMENT.md`ï¼šè¯¦ç»†çš„éƒ¨ç½²ä¼˜åŒ–æŒ‡å—
   - åŒ…å«é—®é¢˜åˆ†æã€è§£å†³æ–¹æ¡ˆã€éƒ¨ç½²æ­¥éª¤å’Œæ•…éšœæ’é™¤

#### æŠ€æœ¯æ”¹è¿›
- **æ–‡ä»¶å¤§å°ä¼˜åŒ–**ï¼šé€šè¿‡ç¦ç”¨ç¼“å­˜å’Œä»£ç åˆ†å‰²ï¼Œé¢„è®¡å¯å°†æ„å»ºæ–‡ä»¶å¤§å°å‡å°‘ 50%
- **æ„å»ºæ€§èƒ½**ï¼šä¼˜åŒ– webpack é…ç½®ï¼Œæå‡æ„å»ºé€Ÿåº¦
- **å…¼å®¹æ€§ä¿®å¤**ï¼šä¿®å¤ Windows æ„å»ºè„šæœ¬å…¼å®¹æ€§
- **éƒ¨ç½²æµç¨‹**ï¼šæ ‡å‡†åŒ– Cloudflare Pages éƒ¨ç½²æµç¨‹
- **ç›‘æ§æœºåˆ¶**ï¼šæ·»åŠ æ„å»ºæ–‡ä»¶å¤§å°ç›‘æ§å’Œè­¦å‘Š

#### æœ€æ–°ä¿®å¤è®°å½•
**é—®é¢˜**: Webpack é…ç½®é”™è¯¯ - `optimization.cache` å±æ€§æ— æ•ˆ
**è§£å†³**: å°† `cache: false` ä» `optimization` å¯¹è±¡ç§»åŠ¨åˆ° webpack é…ç½®çš„é¡¶çº§å±æ€§
**çŠ¶æ€**: âœ… å·²ä¿®å¤ï¼Œæ„å»ºæµ‹è¯•é€šè¿‡

#### é¢„æœŸæ•ˆæœ
- è§£å†³ Cloudflare Pages æ–‡ä»¶å¤§å°é™åˆ¶é—®é¢˜
- ä¿®å¤ webpack é…ç½®é”™è¯¯
- æå‡åº”ç”¨åŠ è½½æ€§èƒ½
- ç®€åŒ–éƒ¨ç½²æµç¨‹
- æä¾›å®Œæ•´çš„æ•…éšœæ’é™¤æŒ‡å—

---

## 2025-01-XX - Husky Pre-commit Hook Windows å…¼å®¹æ€§ä¿®å¤

### ğŸ” é—®é¢˜åˆ†æ
**ä¸»è¦é—®é¢˜**: Husky pre-commit hook åœ¨ Windows ç¯å¢ƒä¸‹å¤±è´¥
- é”™è¯¯ä¿¡æ¯: `/usr/bin/env: 'bash': No such file or directory`
- æ ¹æœ¬åŸå› : 
  1. Windows ç¯å¢ƒä¸‹ bash è·¯å¾„é—®é¢˜
  2. ESLint é…ç½®å†²çªï¼ˆé‡å¤çš„ simple-import-sort æ’ä»¶ï¼‰
  3. next.config.js ä¸­å­˜åœ¨æœªä½¿ç”¨çš„å˜é‡è­¦å‘Š

### âœ… è§£å†³æ–¹æ¡ˆå®æ–½

#### 1. ESLint é…ç½®ä¿®å¤
**æ–‡ä»¶**: `.eslintrc.js`
- æ·»åŠ  `root: true` é˜²æ­¢å‘ä¸ŠæŸ¥æ‰¾é…ç½®æ–‡ä»¶
- è§£å†³æ’ä»¶é‡å¤åŠ è½½é—®é¢˜

#### 2. Webpack é…ç½®ä¼˜åŒ–
**æ–‡ä»¶**: `next.config.js`
- ç§»é™¤æœªä½¿ç”¨çš„ `isServer` å‚æ•°
- ä¿æŒ webpack é…ç½®çš„ç®€æ´æ€§

#### 3. Husky Hook å…¼å®¹æ€§æ”¹è¿›
**æ–‡ä»¶**: `.husky/pre-commit`
- æ·»åŠ  Windows ç¯å¢ƒæ£€æµ‹é€»è¾‘
- æ”¯æŒè·¨å¹³å°è¿è¡Œ
- æ·»åŠ è¯¦ç»†çš„è¿è¡Œæ—¥å¿—

#### 4. PowerShell å¤‡ç”¨æ–¹æ¡ˆ
**æ–‡ä»¶**: `.husky/pre-commit.ps1`
- åˆ›å»º Windows PowerShell ç‰ˆæœ¬çš„ pre-commit hook
- åŒ…å«é”™è¯¯å¤„ç†å’ŒçŠ¶æ€æ£€æŸ¥

#### 5. Package.json é…ç½®ä¼˜åŒ–
**æ–‡ä»¶**: `package.json`
- ä¿®æ”¹ lint-staged é…ç½®ï¼Œå…è®¸ 1 ä¸ªè­¦å‘Šï¼ˆ`--max-warnings=1`ï¼‰
- æ·»åŠ  Windows å…¼å®¹çš„è„šæœ¬ï¼š
  - `prepare:win`: Windows ç¯å¢ƒä¸‹çš„ Husky å®‰è£…
  - `lint:pre-commit`: ç‹¬ç«‹çš„ lint-staged å‘½ä»¤
- æ·»åŠ  Husky hooks é…ç½®

### ğŸ”§ æŠ€æœ¯æ”¹è¿›
1. **è·¨å¹³å°å…¼å®¹æ€§**: æ”¯æŒ Windows å’Œ Unix/Linux ç¯å¢ƒ
2. **é”™è¯¯å¤„ç†**: æ”¹è¿›çš„é”™è¯¯æ£€æµ‹å’ŒæŠ¥å‘Š
3. **é…ç½®éš”ç¦»**: é˜²æ­¢ ESLint é…ç½®å†²çª
4. **çµæ´»çš„è­¦å‘Šå¤„ç†**: å…è®¸å°‘é‡è­¦å‘Šä»¥æé«˜å¼€å‘æ•ˆç‡

### ğŸ“Š ä¿®å¤çŠ¶æ€
- âœ… ESLint é…ç½®å†²çªå·²è§£å†³
- âœ… Windows ç¯å¢ƒå…¼å®¹æ€§å·²ä¿®å¤
- âœ… Pre-commit hook æ­£å¸¸è¿è¡Œ
- âœ… Lint-staged æˆåŠŸæ‰§è¡Œ
- âœ… Git æäº¤æµç¨‹æ¢å¤æ­£å¸¸

### ğŸš€ é¢„æœŸæ•ˆæœ
1. **å¼€å‘ä½“éªŒæå‡**: æ¶ˆé™¤ Windows ç¯å¢ƒä¸‹çš„æäº¤é˜»å¡
2. **ä»£ç è´¨é‡ä¿è¯**: ä¿æŒ ESLint å’Œ Prettier çš„ä»£ç æ£€æŸ¥
3. **è·¨å¹³å°æ”¯æŒ**: å›¢é˜Ÿæˆå‘˜å¯åœ¨ä¸åŒæ“ä½œç³»ç»Ÿä¸‹æ­£å¸¸å¼€å‘
4. **æ„å»ºç¨³å®šæ€§**: å‡å°‘å› ç¯å¢ƒå·®å¼‚å¯¼è‡´çš„æ„å»ºå¤±è´¥